# Install and configure Docker on supported plattforms.
---

- name: Check base OS version requirements
  assert:
    that:
      - ansible_os_family == "RedHat"
      - ansible_distribution_major_version|int >= 7

- name: Register Docker command info
  shell: command -v docker >/dev/null 2>&1 || { echo "1"; }
  register: docker_command_info
  changed_when: False

- name: Register Docker version info
  shell: docker --version
  register: docker_version_info
  when: docker_command_info.stdout != '1'
  changed_when: False

- name: Register Docker install trigger
  shell: echo 1
  register: install_trigger
  when: docker_version_info|skipped or docker_version_info.stdout.find('{{ ansible_docker_node_docker_version }}') == -1

- name: Include OS specific vars
  include_vars: "RedHat.yml"
  when: ansible_os_family == 'RedHat'

- name: Install Docker via script (adds repo and installs docker)
  shell: "curl -sSL https://get.docker.com/ | sed 's/lxc-docker/lxc-docker-{{ ansible_docker_node_docker_version }}/' | sh"
  notify:
    - Restart docker
    - Run hello-world check
    - Assert hello-world check was successful
  when: install_trigger|changed

- name: Enable local users for docker management witout sudo
  user:
    name: "{{ item }}"
    groups: "{{ ansible_docker_node_docker_group }}"
    append: yes
  with_items: "{{ ansible_docker_node_docker_users }}"
  when: ansible_docker_node_docker_users

- name: Ensure the docker daemon starts at boot
  service:
    name: "{{ ansible_docker_node_docker_daemon_name }}"
    enabled: yes
  when: install_trigger|changed
